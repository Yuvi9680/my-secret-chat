<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Assistant</title>
    <!-- Crypto.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    
    <!-- Firebase SDK (Ab humein sirf App aur RTDB chahiye) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* [Style code wahi hai, jagah bachaane ke liye chhipa diya hai] */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; }
        #app-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: none; /* Password ke baad hi dikhega */ flex-direction: column; background-color: #ffffff; max-width: 600px; margin: 0 auto; }
        #header { padding: 16px; background-color: #ffffff; border-bottom: 1px solid #e0e0e0; text-align: center; flex-shrink: 0; }
        #header h3 { margin: 0; font-weight: 600; color: #000; }
        #header p { margin: 4px 0 0; font-size: 13px; color: #ffc107; font-weight: 500; }
        #chat-window { flex-grow: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; user-select: none; -webkit-user-select: none; }
        .message-container { display: flex; margin-bottom: 12px; max-width: 85%; word-wrap: break-word; position: relative; }
        .message-bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; }
        .user-prompt { align-self: flex-end; }
        .user-prompt .message-bubble { background-color: #007bff; color: white; border-top-right-radius: 4px; }
        .ai-response { align-self: flex-start; }
        .ai-response .message-bubble { background-color: #e4e6eb; color: #050505; border-top-left-radius: 4px; }
        .ai-label { font-size: 12px; color: #65676b; margin-bottom: 4px; margin-left: 4px; }
        .locked-message { background-color: #f0f0f0 !important; color: #555 !important; font-family: 'Courier New', monospace; font-size: 13px; cursor: pointer; border: 1px dashed #ccc; }
        .locked-message::before { content: 'üîí '; font-size: 11px; }
        .status-dot { font-size: 10px; color: #a0a0a0; position: absolute; bottom: -15px; right: 0; }
        #input-area { display: flex; padding: 12px; border-top: 1px solid #e0e0e0; background-color: #ffffff; align-items: flex-start; flex-shrink: 0; }
        #message-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 16px; font-size: 15px; line-height: 1.3; outline: none; margin-right: 8px; resize: none; max-height: 100px; overflow-y: auto; }
        #message-input:focus { border-color: #007bff; }
        .chat-button { border: none; background: none; padding: 8px; font-size: 24px; cursor: pointer; color: #007bff; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; flex-shrink: 0; }
        .chat-button:hover { background-color: #f0f0f0; }
        
        /* Delete Menu */
        #delete-menu {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        #delete-menu button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: none;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
        }
        #delete-menu button:hover { background-color: #f0f0f0; }
        #delete-menu button:first-child { border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="header">
            <h3>AI Assistant</h3>
            <p id="status-light">‚óè Connecting...</p>
        </div>
        <div id="chat-window" oncontextmenu="return false;"></div>
        <div id="input-area">
            <textarea id="message-input" placeholder="Yahaan type karein..." rows="1"></textarea>
            <button id="lock-button" class="chat-button" title="Message ko lock karein">üîí</button>
            <button id="send-button" class="chat-button" title="Bhejein">‚û§</button>
        </div>
    </div>
    <div id="delete-menu">
        <button id="delete-me">Delete for Me</button>
        <button id="delete-everyone">Delete for Everyone</button>
    </div>

    <script>
        // --------- PASSWORD PROTECTION ---------
        const correctPassword = "Yuvraj9680";
        let enteredPassword = "";

        function checkPassword() {
            enteredPassword = prompt("Enter password to access chat:");
            if (enteredPassword === correctPassword) {
                document.getElementById('app-container').style.display = 'flex';
                initializeChat();
            } else {
                alert("Galat Password!");
                document.body.innerHTML = '<h1 style="color: red; text-align: center; margin-top: 50px;">Access Denied</h1>';
            }
        }
        window.onload = checkPassword;

        // --------- CHAT LOGIC (Sirf RTDB ke saath) ---------

        function initializeChat() {
            
            // ‚ö†Ô∏è YUVI, AAPKA FIREBASE CONFIG AB YAHAN HAI ‚ö†Ô∏è
            const firebaseConfig = {
              apiKey: "AIzaSyDVSPhPWVwciDfRF-aQbc6zTHBcub1jYmU",
              authDomain: "my-secret-chat-9779b.firebaseapp.com",
              databaseURL: "https://my-secret-chat-9779b-default-rtdb.firebaseio.com",
              projectId: "my-secret-chat-9779b",
              storageBucket: "my-secret-chat-9779b.firebasestorage.app",
              messagingSenderId: "801250293319",
              appId: "1:801250293319:web:811f00e9e6bde564046362",
              measurementId: "G-EL9ZHXP45E"
            };
            // ‚ö†Ô∏è CONFIG UPAR HAI ‚ö†Ô∏è

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const rtdb = firebase.database(); // Sirf Realtime Database

            // --------- CONFIGURATION ---------
            const ROOM_ID = "our-secret-room-v9"; // Naya version (taaki purane logic se conflict na ho)
            const messagesRef = rtdb.ref(`/chats/${ROOM_ID}/messages`);
            const presenceRef = rtdb.ref(`/status/${ROOM_ID}`);

            // DOM Elements
            const chatWindow = document.getElementById('chat-window');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const lockButton = document.getElementById('lock-button');
            const statusLight = document.getElementById('status-light');
            const deleteMenu = document.getElementById('delete-menu');
            const deleteMeBtn = document.getElementById('delete-me');
            const deleteEveryoneBtn = document.getElementById('delete-everyone');

            // Local State
            let myClientId = localStorage.getItem('myClientId');
            if (!myClientId) {
                myClientId = `client_${Math.random().toString(16).substring(2, 10)}`;
                localStorage.setItem('myClientId', myClientId);
            }
            let isLocked = false;
            let selectedMessageId = null;

            // --- 5. Online Status (Presence) ---
            const myPresenceRef = presenceRef.child(myClientId);
            rtdb.ref(".info/connected").on("value", (snap) => {
                if (snap.val() === true) {
                    statusLight.textContent = '‚óè Connected';
                    statusLight.style.color = '#28a745';
                    myPresenceRef.set("online");
                    myPresenceRef.onDisconnect().remove(); 
                } else {
                    statusLight.textContent = '‚óè Connecting...';
                    statusLight.style.color = '#ffc107';
                }
            });

            presenceRef.on("value", (snap) => {
                let isFriendOnline = false;
                snap.forEach((child) => {
                    if (child.key !== myClientId && child.val() === "online") {
                        isFriendOnline = true;
                    }
                });
                
                if (rtdb.ref(".info/connected").val() === false) return;

                if (isFriendOnline) {
                    statusLight.textContent = '‚óè Dost Online';
                    statusLight.style.color = '#28a745';
                } else {
                    statusLight.textContent = '‚óè Dost Offline';
                    statusLight.style.color = '#dc3545';
                }
            });

            // --- 1. Offline Messages (Poori Queue) ---
            messagesRef.orderByChild("timestamp")
                .on("child_added", (snapshot) => {
                    const msgId = snapshot.key;
                    const msgData = snapshot.val();

                    if (msgData.deletedFor && msgData.deletedFor[myClientId]) {
                        return; 
                    }

                    if (msgData.senderId !== myClientId && msgData.seen === true) {
                        messagesRef.child(msgId).child("deletedFor").child(myClientId).set(true); 
                        return; 
                    }
                    
                    if (msgData.senderId === myClientId && msgData.seen === true) {
                        messagesRef.child(msgId).child("deletedFor").child(myClientId).set(true);
                        return; 
                    }


                    displayMessage(msgId, msgData);
                    
                    if (msgData.senderId !== myClientId && !msgData.seen) {
                        messagesRef.child(msgId).update({ seen: true });
                    }
                });
            
            messagesRef.on("child_changed", (snapshot) => {
                const msgId = snapshot.key;
                const msgData = snapshot.val();
                
                const statusDot = document.querySelector(`#${msgId} .status-dot`);
                if(statusDot && msgData.seen){
                    statusDot.textContent = '‚úì Seen';
                    statusDot.style.color = '#007bff';
                }
            });

            messagesRef.on("child_removed", (snapshot) => {
                const msgId = snapshot.key;
                const msgElement = document.getElementById(msgId);
                if (msgElement) {
                    msgElement.remove();
                }
            });


            // -- Event Handlers --
            sendButton.onclick = sendMessage;
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });
            lockButton.onclick = () => {
                isLocked = !isLocked;
                lockButton.style.backgroundColor = isLocked ? '#007bff' : 'transparent';
                lockButton.style.color = isLocked ? 'white' : '#007bff';
            };
            
            deleteMeBtn.onclick = () => {
                if (selectedMessageId) {
                    messagesRef.child(selectedMessageId).child("deletedFor").child(myClientId).set(true);
                    const msgElement = document.getElementById(selectedMessageId);
                    if(msgElement) msgElement.remove();
                }
                deleteMenu.style.display = 'none';
            };
            
            deleteEveryoneBtn.onclick = () => {
                if (selectedMessageId) {
                    messagesRef.child(selectedMessageId).remove();
                }
                deleteMenu.style.display = 'none';
            };
            
            // --- YEH HAI NAYA FIX (Click Event Collision) ---
            chatWindow.onclick = (e) => {
                // Agar message bubble ya uske andar click nahin hua hai, tabhi menu hide karo
                if (!e.target.closest('.message-bubble')) {
                    deleteMenu.style.display = 'none';
                }
            };
            // --- END OF FIX ---


            // -- Functions --

            function sendMessage() {
                const text = messageInput.value.trim();
                if (text === '') return;

                const msgData = {
                    text: text, 
                    senderId: myClientId,
                    seen: false,
                    isLocked: isLocked, 
                    timestamp: firebase.database.ServerValue.TIMESTAMP, 
                    deletedFor: {} 
                };
                
                const newMessageRef = messagesRef.push();
                const msgId = newMessageRef.key;

                if (isLocked) {
                    const password = prompt("Is message ko lock karne ke liye ek password banaayein:");
                    if (!password) { alert("Lock karne ke liye password zaroori hai."); return; }
                    
                    const encryptedText = encryptText(text, password);
                    localStorage.setItem(`lock_enc_${msgId}`, encryptedText);
                    localStorage.setItem(`lock_orig_${msgId}`, text); 

                    newMessageRef.set(msgData); 
                } else {
                    newMessageRef.set(msgId); 
                }

                messageInput.value = '';
                isLocked = false;
                lockButton.style.backgroundColor = 'transparent';
                lockButton.style.color = '#007bff';
                messageInput.style.height = 'auto'; 
            }

            function displayMessage(msgId, msg) {
                const isMe = msg.senderId === myClientId;
                
                const container = document.createElement('div');
                container.id = msgId;
                container.className = `message-container ${isMe ? 'user-prompt' : 'ai-response'}`;

                let bubbleContent = '';
                let textToShow = msg.text;

                if (isMe) {
                    if (msg.isLocked) {
                        const encryptedText = localStorage.getItem(`lock_enc_${msgId}`);
                        if (encryptedText) {
                            // Humne onclick event ko seedha HTML string mein daal diya hai taaki yeh contextmenu se conflict na kare
                            bubbleContent = `
                                <div class="message-bubble locked-message" onclick="unlockMessage(event, '${msgId}')">
                                    ${encryptedText.substring(0, 20)}...
                                </div>
                            `;
                        } else {
                            bubbleContent = `<div class="message-bubble">${msg.text}</div>`;
                        }
                    } else {
                        bubbleContent = `<div class="message-bubble">${textToShow}</div>`;
                    }
                    container.innerHTML = bubbleContent;

                } else {
                    bubbleContent = `<div class="message-bubble">${textToShow}</div>`;
                    container.innerHTML = `
                        <div>
                            <div class="ai-label">[AI]</div>
                            ${bubbleContent}
                        </div>
                    `;
                }
                
                chatWindow.appendChild(container);
                
                const bubble = container.querySelector('.message-bubble');

                if (isMe) {
                    // Long-press (delete)
                    bubble.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        selectedMessageId = msgId;
                        deleteMenu.style.display = 'block';
                        deleteMenu.style.top = `${e.pageY}px`;
                        deleteMenu.style.left = `${e.pageX - 100}px`;
                    });
                }

                if (isMe) {
                    const status = document.createElement('span');
                    status.className = 'status-dot';
                    status.textContent = msg.seen ? '‚úì Seen' : '‚úì Sent';
                    if (msg.seen) status.style.color = '#007bff';
                    container.appendChild(status);
                }

                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            // Is function ko global scope mein rakha taaki inline 'onclick' use call kar sake
            window.unlockMessage = function(event, msgId) {
                event.stopPropagation(); 
                const originalText = localStorage.getItem(`lock_orig_${msgId}`);
                const encryptedText = localStorage.getItem(`lock_enc_${msgId}`);

                const password = prompt("Apna banaya hua password daalein:");
                if (!password) return;
                
                try {
                    const decrypted = decryptText(encryptedText, password);
                    if (decrypted === originalText) {
                        alert(`Asli Text:\n\n${originalText}`);
                    } else {
                        alert("Galat password!");
                    }
                } catch (e) { alert("Galat password!"); }
            }
            
            // -- Crypto Functions --
            function encryptText(text, password) {
                return CryptoJS.AES.encrypt(text, password).toString();
            }
            function decryptText(encryptedText, password) {
                const bytes = CryptoJS.AES.decrypt(encryptedText, password);
                const originalText = bytes.toString(CryptoJS.enc.Utf8);
                if (!originalText) throw new Error("Decryption failed");
                return originalText;
            }

            // Auto-adjust textarea height
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            });
            document.body.oncontextmenu = (e) => e.preventDefault();
            document.body.onselectstart = (e) => e.preventDefault();
            window.addEventListener('beforeunload', () => {
                myPresenceRef.remove();
            });
        }
    </script>
</body>
</html>


